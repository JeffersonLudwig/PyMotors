<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoMind - TCC Inteligente</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <div class="logo">
            <span class="material-icons" style="vertical-align: middle;">psychology</span> 
            AutoMind <span style="font-size: 0.8rem; opacity: 0.7;">(IA Beta)</span>
        </div>
        
        <div class="user-controls">
            <button id="toggle-theme" class="btn-icon"><span class="material-icons">dark_mode</span></button>
            
            {% if current_user.is_authenticated %}
                <span class="welcome">Ol√°, {{ current_user.nome }}</span>
                
                {% if current_user.tipo == 'vendedor' %}
                    <button onclick="toggleForm()" class="btn-primary">+ Anunciar</button>
                {% endif %}
                
                <a href="/logout" class="btn-secondary">Sair</a>
            {% else %}
                <a href="/login" class="btn-primary">Entrar</a>
                <a href="/registro" class="btn-secondary">Criar Conta</a>
            {% endif %}
        </div>
    </header>

    <div class="filtros-container">
        <a href="/" class="chip {{ 'ativo' if not request.args.get('categoria') else '' }}">Todos</a>
        <a href="/?categoria=Carro" class="chip {{ 'ativo' if request.args.get('categoria') == 'Carro' else '' }}">Carros</a>
        <a href="/?categoria=Moto" class="chip {{ 'ativo' if request.args.get('categoria') == 'Moto' else '' }}">Motos</a>
        <a href="/?categoria=Caminhao" class="chip {{ 'ativo' if request.args.get('categoria') == 'Caminhao' else '' }}">Caminh√µes</a>
    </div>

    <div class="container">
        <div id="form-anuncio" class="card-form hidden">
            <div class="form-header">
                <h3>Novo An√∫ncio Inteligente</h3>
                <span class="badge-ia">Powered by AI</span>
            </div>
            
            <form action="/anunciar" method="POST" enctype="multipart/form-data">
                <div class="row">
                    <div class="col">
                        <label>Tipo de Ve√≠culo</label>
                        <select name="categoria" required>
                            <option value="Carro">Carro</option>
                            <option value="Moto">Moto</option>
                            <option value="Caminhao">Caminh√£o</option>
                        </select>
                    </div>
                    <div class="col">
                        <label>Modelo</label>
                        <input type="text" name="modelo" placeholder="Ex: Civic LXR" required>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <label>Marca</label>
                        <input type="text" name="marca" placeholder="Ex: Honda" required>
                    </div>
                    <div class="col">
                        <label>Ano Fabrica√ß√£o</label>
                        <input type="number" id="input-ano" name="ano" placeholder="Ex: 2018" required>
                    </div>
                    <div class="col">
                        <label>Quilometragem (KM)</label>
                        <input type="number" id="input-km" name="km" placeholder="Ex: 65000" required>
                    </div>
                </div>

                <label>Pre√ßo de Venda (R$)</label>
                <div class="row-ia">
                    <input type="number" step="0.01" id="input-preco" name="preco" placeholder="Digite ou use a IA ->" required>
                    
                    <button type="button" onclick="consultarIA()" class="btn-ia">
                        <span class="material-icons">auto_awesome</span> Sugerir Pre√ßo
                    </button>
                </div>
                <p id="msg-ia" class="msg-ia-texto"></p>

                <div class="file-area">
                    <label>Foto do Ve√≠culo</label>
                    <input type="file" name="foto" accept="image/*">
                </div>

                <button type="submit" class="btn-save">Publicar An√∫ncio</button>
            </form>
        </div>

        <div class="grid-carros">
            {% for v in veiculos %}
            <div class="card-carro">
                <div class="img-wrapper">
                    <img src="{{ url_for('static', filename='uploads/' + v.imagem) }}" onerror="this.src='https://via.placeholder.com/300x200?text=Sem+Foto'">
                    <span class="cat-tag">{{ v.categoria }}</span>
                </div>
                <div class="detalhes">
                    <h4>{{ v.modelo }}</h4>
                    <p class="marca">{{ v.marca }} ‚Ä¢ {{ v.ano }}</p>
                    <div class="specs">
                        <span><i class="material-icons" style="font-size: 12px;">speed</i> {{ v.km }} km</span>
                    </div>
                    <p class="preco">R$ {{ "%.2f"|format(v.preco) }}</p>
                    
                    {% if current_user.is_authenticated and current_user.id == v.vendedor_id %}
                        <a href="/deletar/{{ v.id }}" class="btn-delete">Excluir</a>
                    {% else %}
                        <a href="/veiculo/{{ v.id }}" class="btn-buy">Ver Detalhes</a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        function toggleForm() {
            document.getElementById('form-anuncio').classList.toggle('hidden');
        }

        // L√≥gica do Dark Mode
        const toggleBtn = document.getElementById('toggle-theme');
        const icon = toggleBtn.querySelector('span');
        const body = document.body;

        if (localStorage.getItem('theme') === 'dark') {
            body.classList.add('dark-mode');
            icon.textContent = 'light_mode';
        }

        toggleBtn.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            if (body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
                icon.textContent = 'light_mode';
            } else {
                localStorage.setItem('theme', 'light');
                icon.textContent = 'dark_mode';
            }
        });

        // L√≥gica da IA
        async function consultarIA() {
            const ano = document.getElementById('input-ano').value;
            const km = document.getElementById('input-km').value;
            const msg = document.getElementById('msg-ia');
            const campoPreco = document.getElementById('input-preco');
            const btnIA = document.querySelector('.btn-ia');

            if (!ano || !km) {
                msg.style.color = 'red';
                msg.innerText = "‚ö†Ô∏è Preencha Ano e KM para a IA calcular!";
                return;
            }

            msg.style.color = 'var(--primary)';
            msg.innerText = "ü§ñ Analisando mercado...";
            btnIA.classList.add('loading');

            try {
                const response = await fetch('/api/estimar_preco', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ano: ano, km: km })
                });

                const data = await response.json();
                
                campoPreco.value = data.preco_sugerido;
                msg.innerText = "‚úÖ Pre√ßo ideal calculado com base na deprecia√ß√£o!";
                btnIA.classList.remove('loading');
            } catch (error) {
                msg.innerText = "Erro ao conectar com a IA.";
            }
        }
    </script>
</body>
</html>